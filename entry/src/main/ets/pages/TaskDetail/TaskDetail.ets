import { componentSnapshot, promptAction, router } from '@kit.ArkUI'
import {
  DeliverParamsTypeModel,
  ExceptionList,
  PickUpParamsModel,
  TaskDetailInfo,
  TaskDetailInfoModel,
  TaskTypeEnum
} from '../../models'
import {
  CommonRouterParams,
  ImageList,
  Loading,
  Skeleton,
  ToggleCard,
  TopNavBar,
  Upload,
  UploadFile
} from '@presenter/basic'
import { deliverAPI, getTaskDetailAPI, pickUpAPI } from '../../api/modules/taskAPI'
import { common } from '@kit.AbilityKit'
import { call } from '@kit.TelephonyKit'
import { MessageEvents, worker } from '@kit.ArkTS'
import { PostParams } from '../../workers/UploadWorker'
import { image } from '@kit.ImageKit'

class BaseBuilderClass {
  title: string = ""
  value: string = ""
  icon?: ResourceStr = ""
  iconClick?: () => void
}

@Extend(Text)
function baseTextOneStyle() {
  .fontSize(12)
  .fontColor($r('app.color.white'))
  .backgroundColor($r('app.color.text_primary'))
  .width(22)
  .height(22)
  .borderRadius(11)
  .textAlign(TextAlign.Center)
}

@Extend(Text)
function baseTextTwoStyle() {
  .margin({ left: 11.5 }).fontColor($r('app.color.text_secondary')).fontSize(14).lineHeight(20)
}

@Entry
@Component
struct TaskDetail {
  @State
  taskDetailData: TaskDetailInfoModel = new TaskDetailInfoModel({} as TaskDetailInfo)
  scroller: Scroller = new Scroller() // æ»šåŠ¨
  loading: CustomDialogController = new CustomDialogController({
    builder: Loading({ title: 'å¤„ç†ä¸­...' }),
    customStyle: true
  })
  @State
  snapImg: image.PixelMap | null = null
  @State
  showSnap: boolean = false

  /*-----------------------ğŸ‘‡ğŸ‘‡ Builder ğŸ‘‡ğŸ‘‡--------------------------------*/
  // å¸æœºä¿¡æ¯
  @Builder
  getDriverContent() {
    Row() {
      Text("è½¦ç‰Œå·").fontSize(14).fontColor($r('app.color.text_secondary'))
        .lineHeight(20)
      Text(this.taskDetailData.licensePlate).fontSize(14).fontColor($r('app.color.text_secondary'))
    }.justifyContent(FlexAlign.SpaceBetween).width('100%').margin({
      top: 14
    })

    Row() {
      Text(`å¸æœºå§“å`).fontSize(14).fontColor($r('app.color.text_secondary'))
        .lineHeight(20)
      Text(this.taskDetailData.driverName).fontSize(14).fontColor($r('app.color.text_secondary'))
    }.justifyContent(FlexAlign.SpaceBetween).width('100%').margin({
      top: 14
    })
  }

  // è¿è¾“è·¯çº¿
  @Builder
  getTransLineContent() {
    Row() {
      Column() {
        Text(this.taskDetailData.startProvince)
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .lineHeight(22)
          .fontWeight(600)
        Text(this.taskDetailData.startCity).fontSize(14).lineHeight(22)
      }.width(50)

      Image($r("app.media.ic_right_arrow")).width(36).height(16)
      Column() {
        Text(this.taskDetailData.endProvince)
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .lineHeight(22)
          .fontWeight(600)
        Text(this.taskDetailData.endCity).fontSize(14).lineHeight(22)
      }.width(50)
    }.justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center).width('100%').padding({
      left: 60,
      right: 60
    })
  }

  @Builder
  getBaseContentItem(item: BaseBuilderClass) {
    Row() {
      Text(item.title).fontSize(14).fontColor($r('app.color.text_secondary'))
        .lineHeight(20)
      Row() {
        Text(item.value).fontSize(14).fontColor($r('app.color.text_secondary'))
        if (item.icon) {
          Image(item.icon).width(24).height(24)
            .onClick(() => {
              item.iconClick && item.iconClick()
            })
        }
      }
    }.justifyContent(FlexAlign.SpaceBetween).width('100%').margin({
      top: 14
    })
  }

  // è·å–åŸºç¡€ä¿¡æ¯
  @Builder
  getBaseContent() {
    Row() {
      Column() {
        Row() {
          Text("èµ·").baseTextOneStyle()
          Text("åœ°å€åœ°å€").baseTextTwoStyle()
        }.margin({ top: 21 })

        Row() {
          Text("æ­¢").baseTextOneStyle().backgroundColor($r('app.color.primary'))
          Text("æ²³å—çœéƒ‘å·å¸‚è·¯åŒ—åŒºåŒ—æ¸…è·¯99å·").baseTextTwoStyle()
        }.margin({ top: 14.5 })
      }.alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({
        right: 20
      })

      // é€è´§è¿‡ç¨‹ä¸­æ‰æ˜¾ç¤ºå¯¼èˆª
      if (this.taskDetailData.status === TaskTypeEnum.Line) {
        Column() {
          Image($r("app.media.ic_navigation")).width(22).height(22)
          Text("å¼€å§‹å¯¼èˆª").fontSize(14).margin({ top: 10, bottom: 10 })
        }.justifyContent(FlexAlign.SpaceBetween)
        .margin({
          top: 20
        })
        .onClick(() => {
          // å¼€å¯å¯¼èˆª
          this.beginNav()
        })
      }

    }.justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center).width('100%')

    Divider().vertical(false).height(2).color($r('app.color.background_divider')).margin({ left: 8, right: 8, top: 21 })
    this.getBaseContentItem({
      title: 'ä»»åŠ¡ç¼–å·',
      value: '2132324324343434'
    })
    this.getBaseContentItem({
      title: 'è”ç³»äºº',
      value: '2132324324343434',
      iconClick: () => {
        call.makeCall(this.taskDetailData.startHandoverPhone)
      }
    })
    this.getBaseContentItem({
      title: 'è”ç³»ç”µè¯',
      value: '2132324324343434',
      icon: $r('app.media.ic_phone')
    })
    this.getBaseContentItem({
      title: 'æè´§æ—¶é—´',
      value: '2132324324343434'
    })
    this.getBaseContentItem({
      title: 'é¢„è®¡é€è¾¾æ—¶é—´',
      value: '2132324324343434'
    })

  }

  // åº•éƒ¨æŒ‰é’®ç»“æ„
  @Builder
  getBottomBtn() {
    //å·²å®Œæˆä¸æ˜¾ç¤ºä»»ä½•æŒ‰é’®
    Row() {
      if (this.taskDetailData.status === TaskTypeEnum.Waiting) {
        Button("å»¶è¿Ÿæ”¶è´§", { type: ButtonType.Capsule })
          .backgroundColor($r('app.color.btn_gray'))
          .fontColor($r('app.color.text_primary'))
          .fontSize(16)
          .height(50)
          .width(125)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/DelayPage/DelayPage',
              params: {
                id: this.taskDetailData.id,
                oldTime: this.taskDetailData.planDepartureTime // è®¡åˆ’æ—¶é—´
              }
            })
          })
        Button("æè´§", { type: ButtonType.Capsule })
          .backgroundColor($r('app.color.primary'))
          .fontColor($r('app.color.white'))
          .height(50)
          .flexGrow(1)
          .margin({ left: 13 })
          .enabled(this.getPickUpState())
          .onClick(() => {
            this.btnPickUp()
          })
      } else if (this.taskDetailData.status === TaskTypeEnum.Line) {
        Button("ä¸ŠæŠ¥å¼‚å¸¸", { type: ButtonType.Capsule })
          .backgroundColor($r('app.color.btn_gray'))
          .fontColor($r('app.color.text_primary'))
          .fontSize(16)
          .height(50)
          .width(125)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/Report/Report',
              params: {
                id: this.taskDetailData.transportTaskId // idå¹¶ä¸æ˜¯è®¢å•çš„id è€Œæ˜¯transportTaskId
              }
            })
          })
        Button("äº¤è´§", { type: ButtonType.Capsule })
          .backgroundColor($r('app.color.primary'))
          .fontColor($r('app.color.white'))
          .height(50)
          .flexGrow(1)
          .enabled(this.getDeliverState())
          .margin({ left: 13 })
          .onClick(() => {
            this.btnDeliver()
          })

      } else if (this.taskDetailData.status === TaskTypeEnum.Delivered) {
        Row() {
          // å·²äº¤ä»˜æ˜¾ç¤ºå›è½¦ç™»è®°
          Button("å›è½¦ç™»è®°", { type: ButtonType.Capsule })
            .backgroundColor($r('app.color.primary'))
            .fontColor($r('app.color.white'))
            .height(50)
            .width('80%')
            .onClick(() => {
              router.pushUrl({
                url: 'pages/CarRecord/CarRecord',
                params: {
                  id: this.taskDetailData.id,
                  // time: this.taskDetailData.actualDepartureTime
                }
              })
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
      }

    }
    .width('100%')
    .padding({ left: 15, right: 15 })
    .height(70)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
    .backgroundColor($r('app.color.white'))
  }

  // æè´§ä¿¡æ¯å†…å®¹
  @Builder
  getPickUpContent() {
    // @Linkä¿®é¥°ç¬¦ ä¿®é¥°åªèƒ½æ˜¯ä¸€å±‚æ•°æ®
    Upload({
      title: 'è¯·æ‹ç…§ä¸Šä¼ å›å•å‡­è¯',
      imgList: this.taskDetailData.cargoPickUpPictureList || [], // çˆ¶ç»„ä»¶ç»™å­ç»„ä»¶ä¼ 
      onListChange: (list: ImageList[]) => {
        this.taskDetailData.cargoPickUpPictureList = list // å­ç»„ä»¶ç»™çˆ¶ç»„ä»¶ä¼ 
      },
      canUpload: this.taskDetailData.status === TaskTypeEnum.Waiting
    })
    Upload({
      title: 'è¯·æ‹ç…§ä¸Šä¼ è´§å“ç…§ç‰‡',
      imgList: this.taskDetailData.cargoPictureList || [],
      onListChange: (list: ImageList[]) => {
        this.taskDetailData.cargoPictureList = list
      },
      canUpload: this.taskDetailData.status === TaskTypeEnum.Waiting

    })
  }

  // äº¤è´§ä¿¡æ¯
  @Builder
  getDeliverContent() {
    // @Linkä¿®é¥°ç¬¦ ä¿®é¥°åªèƒ½æ˜¯ä¸€å±‚æ•°æ®
    Upload({
      title: 'è¯·æ‹ç…§ä¸Šä¼ äº¤è´§å›å•å‡­è¯',
      imgList: this.taskDetailData.certificatePictureList || [], // çˆ¶ç»„ä»¶ç»™å­ç»„ä»¶ä¼ 
      onListChange: (list: ImageList[]) => {
        this.taskDetailData.certificatePictureList = list // å­ç»„ä»¶ç»™çˆ¶ç»„ä»¶ä¼ 
      },
      canUpload: this.taskDetailData.status === TaskTypeEnum.Line

    })
    Upload({
      title: 'è¯·æ‹ç…§ä¸Šä¼ äº¤è´§è´§å“ç…§ç‰‡',
      imgList: this.taskDetailData.deliverPictureList || [],
      onListChange: (list: ImageList[]) => {
        this.taskDetailData.deliverPictureList = list
      },
      canUpload: this.taskDetailData.status === TaskTypeEnum.Line
    })
  }

  // è·å–å¼‚å¸¸ä¿¡æ¯
  @Builder
  getExceptionContent() {
    ForEach(this.taskDetailData.exceptionList, (item: ExceptionList) => {
      Row() {
        Column() {
          Row() {
            Text("ä¸ŠæŠ¥æ—¶é—´").fontSize(14).fontColor($r('app.color.text_primary'))
            Text(item.exceptionTime).margin({ left: 20 }).fontColor($r('app.color.text_secondary'))
          }.height(50).alignItems(VerticalAlign.Center).width('100%')

          Row() {
            Text("å¼‚å¸¸ç±»å‹").fontSize(14).fontColor($r('app.color.text_primary'))
            Text(item.exceptionType).margin({ left: 20 }).fontColor($r('app.color.text_secondary'))
          }.height(50).alignItems(VerticalAlign.Center).width('100%')

          Row() {
            Text("å¤„ç†ç»“æœ").fontSize(14).fontColor($r('app.color.text_primary'))
            Text("ç»§ç»­è¿è¾“").margin({ left: 20 }).fontColor($r('app.color.text_secondary'))
          }.height(50).alignItems(VerticalAlign.Center).width('100%')
        }

        // è·³è½¬åˆ°è¯¦æƒ…
        Image($r("app.media.ic_btn_more")).width(24).height(24)
      }
      .width('100%')
      .padding({ left: 15, right: 15 })
      .alignItems(VerticalAlign.Center)
      .justifyContent(FlexAlign.SpaceBetween)
      .onClick(() => {
        router.pushUrl({
          url: 'pages/Report/ReportDetail',
          params: {
            formData: item
          }
        })
      })

    })
  }

  @Builder
  getSnapContent() {
    Column() {
      Image(this.snapImg)
        .width("100%")
        .height("100%")
        .objectFit(ImageFit.Auto)
        .borderRadius(6)
    }
    .padding("10%")
    .width("100%")
    .height("100%")
    .backgroundColor("rgba(0,0,0,0.2)")
    .onClick(() => {
      this.showSnap = false
    })
  }

  /*-----------------------ğŸ‘‡ğŸ‘‡ function ğŸ‘‡ğŸ‘‡--------------------------------*/
  aboutToAppear() {
    const params = router.getParams() as CommonRouterParams
    if (params && params.id) {
      this.getTaskDetail(params.id)
    }
  }

  onPageShow(): void {
    const params = router.getParams() as CommonRouterParams
    if (params && params.addExcept) {
      // æ­¤æ—¶éœ€è¦æ›´æ–°å¼‚å¸¸ä¿¡æ¯ å…¶ä»–ä¿¡æ¯ä¸æ›´æ–°
      this.updateException()
    }
  }

  async updateException() {
    // åªæ›´æ–°å¼‚å¸¸ä¿¡æ¯çš„å­—æ®µ
    this.taskDetailData.exceptionList = (await getTaskDetailAPI(this.taskDetailData.id)).exceptionList
  }

  async getTaskDetail(id: string) {
    this.taskDetailData = await getTaskDetailAPI(id)
  }

  // å»æè´§
  async btnPickUp() {
    this.loading.open()
    // å»ºç«‹å­çº¿ç¨‹
    const imageCompress1 = new worker.ThreadWorker("entry/ets/workers/UploadWorker.ets") // å­çº¿ç¨‹1
    const imageCompress2 = new worker.ThreadWorker("entry/ets/workers/UploadWorker.ets") // å­çº¿ç¨‹2
    let cargoPickUpPictureList: ImageList[] = []
    let cargoPictureList: ImageList[] = []

    imageCompress1.onmessage = (e: MessageEvents) => {
      const params = e.data as PostParams
      cargoPickUpPictureList = params.files // å·²ç»å‹ç¼©å®Œæ¯•çš„å›¾ç‰‡
      checkFile() // æ£€æŸ¥æ˜¯å¦éƒ½å®Œæˆäº†
    }
    imageCompress2.onmessage = (e: MessageEvents) => {
      const params = e.data as PostParams
      cargoPictureList = params.files // å·²ç»å‹ç¼©å®Œæ¯•çš„å›¾ç‰‡
      checkFile()
    }
    imageCompress1.postMessage({
      files: [...this.taskDetailData.cargoPickUpPictureList],
      filePath: getContext().filesDir
    }) // ç»™å­çº¿ç¨‹å‘æ¶ˆæ¯
    imageCompress2.postMessage({
      files: [...this.taskDetailData.cargoPictureList],
      filePath: getContext().filesDir
    }) // ç»™å­çº¿ç¨‹å‘æ¶ˆæ¯

    const checkFile = async () => {
      if (cargoPickUpPictureList.length && cargoPictureList.length) {
        const result = await Promise.all([UploadFile(cargoPickUpPictureList), UploadFile(cargoPictureList)])
        // æè´§æ“ä½œ
        await pickUpAPI(new PickUpParamsModel({
          id: this.taskDetailData.id,
          cargoPickUpPictureList: result[0],
          cargoPictureList: result[1]
        }))
        this.getTaskDetail(this.taskDetailData.id) // é‡æ–°æ‹‰å–æ•°æ®
        this.scroller.scrollEdge(Edge.Top)
        this.loading.close()
        promptAction.showToast({ message: 'æè´§æˆåŠŸ' })
      }
    }


  }

  // è·å–æè´§æŒ‰é’®çš„çŠ¶æ€
  getPickUpState() {
    return this.taskDetailData.cargoPickUpPictureList?.length > 0 &&
      this.taskDetailData.cargoPictureList?.length > 0 &&
    this.taskDetailData.cargoPickUpPictureList.every(item =>!!item.url) &&
    this.taskDetailData.cargoPictureList.every(item =>!!item.url)
  }

  // æ§åˆ¶æè´§æŒ‰é’®å¯ç”¨æ€§
  getDeliverState() {
    // å¯ç”¨ å‡­è¯æœ‰å›¾ç‰‡ è´§å“æœ‰å›¾ç‰‡ å°±å¯ä»¥ç‚¹æè´§
    if (this.taskDetailData.deliverPictureList?.length
      && this.taskDetailData.deliverPictureList?.every(item =>!!item.url)
      && this.taskDetailData.certificatePictureList?.length
      && this.taskDetailData.certificatePictureList?.every(item =>!!item.url)) {
      return true
    }
    return false
  }

  // äº¤è´§
  async btnDeliver() {
    this.loading.open()
    // å»ºç«‹å­çº¿ç¨‹
    const imageCompress1 = new worker.ThreadWorker("entry/ets/workers/UploadWorker.ets") // å­çº¿ç¨‹1
    const imageCompress2 = new worker.ThreadWorker("entry/ets/workers/UploadWorker.ets") // å­çº¿ç¨‹2
    let certificatePictureList: ImageList[] = []
    let deliverPictureList: ImageList[] = []
    imageCompress1.onmessage = (e: MessageEvents) => {
      const params = e.data as PostParams
      certificatePictureList = params.files // å·²ç»å‹ç¼©å®Œæ¯•çš„å›¾ç‰‡
      checkFile() // æ£€æŸ¥æ˜¯å¦éƒ½å®Œæˆäº†
    }
    imageCompress2.onmessage = (e: MessageEvents) => {
      const params = e.data as PostParams
      deliverPictureList = params.files // å·²ç»å‹ç¼©å®Œæ¯•çš„å›¾ç‰‡
      checkFile()
    }
    imageCompress1.postMessage({
      files: [...this.taskDetailData.certificatePictureList],
      filePath: getContext().filesDir
    }) // ç»™å­çº¿ç¨‹å‘æ¶ˆæ¯
    imageCompress2.postMessage({
      files: [...this.taskDetailData.deliverPictureList],
      filePath: getContext().filesDir
    }) // ç»™å­çº¿ç¨‹å‘æ¶ˆæ¯
    // ç”¨æ¥æ£€æŸ¥æ˜¯å¦å…¨éƒ¨éƒ½å‹ç¼©å®Œæ¯•
    const checkFile = async () => {
      if (certificatePictureList.length && deliverPictureList.length) {
        // æ­¤æ—¶æ­¤åˆ»æ‰å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ
        const result = await Promise.all([UploadFile(certificatePictureList), UploadFile(deliverPictureList)])
        await deliverAPI(new DeliverParamsTypeModel({
          id: this.taskDetailData.id,
          certificatePictureList: result[0],
          deliverPictureList: result[1]
        }))
        this.getTaskDetail(this.taskDetailData.id) // é‡æ–°æ‹‰å–æ•°æ®
        this.scroller.scrollEdge(Edge.Top)
        promptAction.showToast({ message: 'äº¤è´§æˆåŠŸ' })
        this.loading.close()
      }
    }
  }

  // å¯¼èˆª  æ‹‰èµ·ç¬¬ä¸‰æ–¹çš„åº”ç”¨
  beginNav() {
    const context = getContext() as common.UIAbilityContext
    context.startAbility({
      action: 'ohos.want.action.viewData', // æ‹‰èµ·æµè§ˆå™¨åº”ç”¨
      entities: ['entity.system.browsable'],
      uri: encodeURI('https://gaode.com/search?query=' + this.taskDetailData.endAddress)
    })
  }

  build() {
    Column() {
      if (!this.taskDetailData.id) {
        Skeleton()
      } else {

        TopNavBar({ title: 'ä»»åŠ¡è¯¦æƒ…' })
        Scroll(this.scroller) {
          Column() {
            Row() {
              Image($r("app.media.share"))
                .width(20)
                .height(20)
                .fillColor($r("app.color.primary"))
                .onClick(async () => {
                  this.snapImg = await componentSnapshot.get("CutImg")
                  this.showSnap = true
                  // const res = getInspectorByKey("CutImg")
                })
            }
            .width("100%")
            .justifyContent(FlexAlign.End)
            .padding(10)

            ToggleCard({ title: 'åŸºæœ¬ä¿¡æ¯' }) {
              this.getBaseContent()
            }

            ToggleCard({ title: 'è½¦è¾†å¸æœºä¿¡æ¯' }) {
              this.getDriverContent()
            }

            ToggleCard({ title: 'è¿è¾“è·¯çº¿' }) {
              this.getTransLineContent()
            }

            if (this.taskDetailData.status === TaskTypeEnum.Waiting
              || this.taskDetailData.status === TaskTypeEnum.Delivered
              || this.taskDetailData.status === TaskTypeEnum.Finish
            ) {
              ToggleCard({ title: 'æè´§ä¿¡æ¯' }) {
                this.getPickUpContent()
              }
            }
            if (this.taskDetailData.status === TaskTypeEnum.Line
              || this.taskDetailData.status === TaskTypeEnum.Delivered
              || this.taskDetailData.status === TaskTypeEnum.Finish
            ) {
              ToggleCard({ title: 'äº¤è´§ä¿¡æ¯' }) {
                // ä¸Šä¼ ç»„ä»¶ åŸºç¡€ç»„ä»¶
                this.getDeliverContent()
              }
            }
          }
          .padding({
            bottom: 10
          })
          .layoutWeight(1)
        }
        .margin({ bottom: 10 })
        .layoutWeight(1)

        this.getBottomBtn() // åº•éƒ¨æŒ‰é’®ç»“æ„
      }
    }
    .padding({
      top: JSON.parse(AppStorage.get("topHeight")),
      bottom: JSON.parse(AppStorage.get('bottomHeight'))
    })
    .height('100%')
    .backgroundColor($r('app.color.background_page'))
    .id('CutImg')
    .bindContentCover($$this.showSnap, this.getSnapContent(), {
      modalTransition: ModalTransition.NONE
    })
  }
}

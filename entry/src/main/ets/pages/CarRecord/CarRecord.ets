import { Card, CardItem, CheckBox, CommonRouterParams, DateFormat, Loading, TopNavBar } from '@presenter/basic'
import {
  CarRecordType,
  CarRecordTypeModel,
  TaskDetailInfo,
  TaskDetailInfoModel
} from '../../models'
import { promptAction, router } from '@kit.ArkUI'
import { carRecordAPI, getTaskDetailAPI } from '../../api/modules/taskAPI'

@Entry
@Component
struct CarRecord {
  @State
  taskDetailData: TaskDetailInfoModel = new TaskDetailInfoModel({} as TaskDetailInfo)
  @State
  carRecord: CarRecordTypeModel = new CarRecordTypeModel({} as CarRecordType)
  loading: CustomDialogController = new CustomDialogController({
    builder: Loading({ title: 'æäº¤ä¸­...' }),
    customStyle: true
  })

  /*-----------------------ðŸ‘‡ðŸ‘‡ function ðŸ‘‡ðŸ‘‡--------------------------------*/

  aboutToAppear() {
    const params = router.getParams() as CommonRouterParams
    if (params && params.id) {
      this.getTaskDetail(params.id)
    }
  }

  async getTaskDetail(id: string) {
    this.taskDetailData = await getTaskDetailAPI(id)
  }

  // æ£€æŸ¥å†æäº¤
  async btnCarRecord() {
    if (!this.carRecord.endTime) {
      promptAction.showToast({ message: 'è¯·é€‰æ‹©å›žè½¦æ—¶é—´' })
      return
    }
    this.carRecord.startTime = this.taskDetailData.actualDepartureTime
    // è¿è¾“ä»»åŠ¡id
    this.carRecord.id = this.taskDetailData.transportTaskId
    this.loading.open()
    await carRecordAPI(this.carRecord)
    this.loading.close()
    promptAction.showToast({ message: 'å›žè½¦ç™»è®°æˆåŠŸ' })
    router.clear() // æ¸…ç©ºé¡µé¢æ ˆ
    router.replaceUrl({ url: 'pages/Main/Index' })
  }

  build() {
    Column() {
      TopNavBar({ title: 'å›žè½¦ç™»è®°' })
      Scroll() {
        Column() {
          Card() {
            CardItem({
              leftTitle: 'å‡ºè½¦æ—¶é—´',
              showRightIcon: false,
              rightText: this.taskDetailData.actualDepartureTime || '',
            })
            CardItem({
              leftTitle: 'å›žè½¦æ—¶é—´',
              rightText: this.carRecord.endTime || 'è¯·é€‰æ‹©',
              showBottomBorder: false,
              onRightClick: () => {
                DatePickerDialog.show({
                  showTime: true,
                  useMilitaryTime: true,
                  onDateAccept: (value: Date) => {
                    this.carRecord.endTime = DateFormat(value)
                  }
                })
              }

            })
          }

          CheckBox({
            title: 'è½¦è¾†è¿ç« ',
            value: !!this.carRecord.isBreakRules,
            checkChange: (value) => {
              this.carRecord.isBreakRules = value
            }
          })
          CheckBox({
            title: 'è½¦è¾†æ•…éšœ',
            value: !!this.carRecord.isFault,
            checkChange: (value) => {
              this.carRecord.isFault = value
            }
          })
          CheckBox({
            title: 'è½¦è¾†äº‹æ•…',
            value: !!this.carRecord.isAccident,
            checkChange: (value) => {
              this.carRecord.isAccident = value
            }
          })
        }
        .height('100%')
      }
      .layoutWeight(1)

      // åº•éƒ¨å†…å®¹
      Row() {
        Button("äº¤è½¦", { type: ButtonType.Capsule })
          .backgroundColor($r('app.color.primary'))
          .width(207)
          .height(50)
          .onClick(() => {
            this.btnCarRecord()
          })
      }
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)
      .padding({
        top: JSON.parse(AppStorage.get('bottomHeight')),
        bottom: JSON.parse(AppStorage.get('bottomHeight')) + 20
      })
      .width('100%')
      .height(70)
      .backgroundColor($r('app.color.white'))
    }
    .padding({
      top: JSON.parse(AppStorage.get("topHeight")),

    })
    .height('100%')
    .backgroundColor($r('app.color.background_page'))
  }
}
import {
  Card,
  CardItem,
  checkPermission,
  CommonRouterParams,
  DateFormat,
  SelectCard,
  TopNavBar,
  Upload,
  UploadFile
} from '@presenter/basic'
import { promptAction, router } from '@kit.ArkUI'
import { ExceptionParamsType, ExceptionParamsTypeModel } from '../../models'
import { abilityAccessCtrl, bundleManager, common, Permissions } from '@kit.AbilityKit'
import { exceptionReportAPI } from '../../api/modules/taskAPI'

@Entry
@Component
struct Report {
  @State
  exceptionForm: ExceptionParamsTypeModel = new ExceptionParamsTypeModel({} as ExceptionParamsType)
  @State
  selectIndex: number = -1
  exceptionList: string[] = ["å‘åŠ¨æœºå¯ç”¨å›°éš¾", "ä¸ç€è½¦ï¼Œæ¼æ²¹", "ç…§æ˜å¤±çµ", "æœ‰å¼‚å¸¸å“åŠ¨", "æ’çƒŸå¼‚å¸¸æ¸©åº¦å¼‚å¸¸", "å…¶ä»–é—®é¢˜"]
  // é€‰æ‹©ç±»å‹çš„å¼¹å±‚
  selectDialog: CustomDialogController = new CustomDialogController({
    builder: SelectCard({
      cardContent: () => {
        // å¿…é¡»è°ƒç”¨ä¸€ä¸ªbuilderçš„å‡½æ•°
        this.getCardContent()
      },
      confirm: () => {
        if (this.selectIndex > -1) {
          this.exceptionForm.exceptionType = this.exceptionList[this.selectIndex]
        }
        this.selectDialog.close()
      }
    }),
    customStyle: true,
    alignment: DialogAlignment.Bottom
  })

  @Builder
  getCardContent() {
    ForEach(this.exceptionList, (item: string, index: number) => {
      this.getSingleItem(item, index, index !== this.exceptionList.length - 1)
    })
  }

  @Builder
  getSingleItem(item: string, index: number, showBorder: boolean) {
    Row() {
      Text(item)
        .fontSize(14)
        .fontColor($r("app.color.text_primary"))
      Image(this.selectIndex === index ? $r("app.media.ic_check_true") : $r("app.media.ic_check_false"))
        .width(32)
        .height(32)
    }
    .onClick(() => {
      this.selectIndex = index // èµ‹å€¼ç´¢å¼•
    })
    .height(60)
    .width("100%")
    .justifyContent(FlexAlign.SpaceBetween)
    .border({
      color: $r("app.color.background_divider"),
      width: {
        bottom: showBorder ? 1 : 0
      }
    })
  }

  /*-----------------------ğŸ‘‡ğŸ‘‡ function ğŸ‘‡ğŸ‘‡--------------------------------*/
  // aboutToAppear() {
  //   const params = router.getParams() as CommonRouterParams
  //   if (params && params.id) {
  //     this.exceptionForm.transportTaskId = params.id
  //   }
  // }
  onPageShow(): void {
    const params = router.getParams() as CommonRouterParams
    if (params && params.location) {
      this.exceptionForm.exceptionPlace = params.location
    }
    if (params && params.id) {
      this.exceptionForm.transportTaskId = params.id
    }
  }

  getBtnEnable() {
    return !!(this.exceptionForm.exceptionDescribe &&
    this.exceptionForm.exceptionPlace &&
    this.exceptionForm.exceptionType &&
    this.exceptionForm.exceptionTime)
  }

  async submit() {
    // å…ˆä¸Šä¼  å†è°ƒç”¨æ¥å£
    if (this.exceptionForm.exceptionImagesList?.length) {
      // äº‘ç«¯åœ°å€
      this.exceptionForm.exceptionImagesList = await UploadFile(this.exceptionForm.exceptionImagesList)
    }
    // è°ƒç”¨æ¥å£
    await exceptionReportAPI(this.exceptionForm) // ä¸ŠæŠ¥å¼‚å¸¸
    promptAction.showToast({ message: 'ä¸ŠæŠ¥æˆåŠŸ' })
    router.back({
      url: 'pages/TaskDetail/TaskDetail',
      params: {
        addExcept: true // è¡¨ç¤ºä¸ŠæŠ¥å¼‚å¸¸æˆåŠŸ
      }
    })
  }

  /*è¯·æ±‚æƒé™æ–¹æ³•*/
  // async checkPermission(requestPermission: Permissions[], permission: Permissions, mess: string, callback: () => void) {
  // /* [
  //        "ohos.permission.LOCATION",
  //        "ohos.permission.APPROXIMATELY_LOCATION"
  //      ]*/
  //   try {
  //     const manager = abilityAccessCtrl.createAtManager() // åˆ›å»ºç¨‹åºæ§åˆ¶ç®¡ç†å™¨
  //     await manager.requestPermissionsFromUser(getContext(), requestPermission) //ç”³è¯·æƒé™
  //     // è·å–åº”ç”¨ä¿¡æ¯
  //     const buildInfo =
  //       bundleManager.getBundleInfoForSelfSync(bundleManager.BundleFlag.GET_BUNDLE_INFO_WITH_APPLICATION)
  //     const status = manager.checkAccessTokenSync(buildInfo.appInfo?.accessTokenId, permission)
  //     // promptAction.showDialog({ message: JSON.stringify(abilityAccessCtrl.GrantStatus.PERMISSION_DENIED) })
  //     if (status === abilityAccessCtrl.GrantStatus.PERMISSION_DENIED) {
  //       AlertDialog.show(
  //         {
  //           message: mess,
  //           autoCancel: true,
  //           alignment: DialogAlignment.Center,
  //           primaryButton: {
  //             value: 'å»ç”³è¯·',
  //             fontColor: Color.Black,
  //             action: () => {
  //               promptAction.showToast({ message: 'ç¡®è®¤' })
  //               // ä¸è¢«å…è®¸
  //               const context = getContext() as common.UIAbilityContext
  //               context.startAbility({
  //                 bundleName: 'com.huawei.hmos.settings',
  //                 abilityName: 'com.huawei.hmos.settings.MainAbility',
  //                 uri: "application_info_entry",
  //                 parameters: {
  //                   pushParams: buildInfo.name
  //                 }
  //               })
  //             }
  //           },
  //           secondaryButton: {
  //             value: 'å–æ¶ˆç”³è¯·',
  //             fontColor: Color.Red,
  //             action: () => {
  //               promptAction.showToast({ message: 'å–æ¶ˆ' })
  //             }
  //           },
  //         })
  //     } else {
  //       callback && callback()
  //
  //     }
  //   } catch (error) {
  //
  //   }
  // }

  build() {
    Column() {
      TopNavBar({ title: 'ä¸ŠæŠ¥å¼‚å¸¸' })
      Scroll() {
        Column() {
          Card() {
            CardItem({
              leftTitle: 'å¼‚å¸¸æ—¶é—´',
              rightText: this.exceptionForm.exceptionTime || 'è¯·é€‰æ‹©',
              onRightClick: () => {
                DatePickerDialog.show({
                  showTime: true,
                  useMilitaryTime: true,
                  onDateAccept: (value) => {
                    this.exceptionForm.exceptionTime = DateFormat(value)
                  }
                })
              }
            })
            CardItem({
              leftTitle: 'ä¸ŠæŠ¥ä½ç½®',
              rightText: 'è¯·é€‰æ‹©',
              onRightClick: () => {
                const requestPermission: Permissions[] = [
                  "ohos.permission.LOCATION",
                  "ohos.permission.APPROXIMATELY_LOCATION"
                ]
                const permission: Permissions = 'ohos.permission.LOCATION'
                const mess = 'ä½¿ç”¨å®šä½éœ€è¦ç”³è¯·å®šä½é£æƒé™'

                const callback = () => {
                  router.pushUrl({
                    url: "pages/SelectLocation/SelectLocation"
                  })
                }

                checkPermission(requestPermission, permission, mess, () => {
                  callback()
                })

              }
            })
            CardItem({
              leftTitle: 'å¼‚å¸¸ç±»å‹',
              rightText: this.exceptionForm.exceptionType || 'è¯·é€‰æ‹©',
              onRightClick: () => {
                this.selectDialog.open()
              }
            })
            CardItem({
              leftTitle: 'å¼‚å¸¸æè¿°',
              rightText: '',
              showRightIcon: false,
              showBottomBorder: false
            })
            TextArea({
              placeholder: 'è¯·è¾“å…¥å¼‚å¸¸æè¿°'
            }).height(130).borderRadius(8).placeholderColor($r('app.color.text_secondary')).fontSize(14)
            Text(`0/50`)
              .margin({
                top: -30
              })
              .textAlign(TextAlign.End)
              .width('100%')
              .padding({ right: 15 })
              .fontColor($r('app.color.text_secondary'))
            Row().height(20)

          }

          Card() {
            Upload({
              title: 'ä¸Šä¼ å›¾ç‰‡(æœ€å¤š6å¼ )',
              imgList: this.exceptionForm.exceptionImagesList || [],
              canUpload: true,
              onListChange: (list) => {
                this.exceptionForm.exceptionImagesList = list // æ¥å›ä¼ å›çš„æ•°ç»„ ç›¸å†Œåœ°å€ å¹¶ä¸æ˜¯çº¿ä¸Šåœ°å€
              }
            })
            Row().height(20)
          }
        }
      }.padding({
        bottom: 80
      })
      .layoutWeight(1)


      Row() {
        Button("æäº¤")
          .height(50)
          .width(207)
          .backgroundColor($r('app.color.primary_disabled'))
          .enabled(this.getBtnEnable())
      }
      .position({
        y: '100%'
      })
      .height(70)
      .translate({
        y: -70
      })
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor($r('app.color.white'))
    }
    .padding({
      top: JSON.parse(AppStorage.get("topHeight")),
      bottom: JSON.parse(AppStorage.get('bottomHeight'))
    })
    .height('100%')
    .backgroundColor($r('app.color.background_page'))
  }
}